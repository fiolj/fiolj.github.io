

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5.3.3 KOKKOS package &mdash; SPARTA 7 May 2020 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/rtd_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> SPARTA
          

          
          </a>

          
            
            
              <div class="version">
                3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Section_intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_start.html">2. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_commands.html">3. Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_packages.html">4. Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_accelerate.html">5. Accelerating SPARTA performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_howto.html">6. How-to discussions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_example.html">7. Example problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_perf.html">8. Performance &amp; scalability</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_tools.html">9. Additional tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_modify.html">10. Modifying &amp; extending SPARTA</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_python.html">11. Python interface to SPARTA</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_errors.html">12. Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_history.html">13. Future and history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SPARTA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>5.3.3 KOKKOS package</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/accelerate_kokkos.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p><a class="reference internal" href="Section_accelerate.html#accelerating"><span class="std std-ref">Return to Section accelerate overview</span></a></p>
<div class="section" id="kokkos-package">
<span id="accelerate-kokkos"></span><h1>5.3.3 KOKKOS package<a class="headerlink" href="#kokkos-package" title="Permalink to this headline">¶</a></h1>
<p>Kokkos is a templated C++ library that provides abstractions to allow a
single implementation of an application kernel (e.g. a collision style)
to run efficiently on different kinds of hardware, such as GPUs, Intel
Xeon Phis, or many-core CPUs. Kokkos maps the C++ kernel onto different
backend languages such as CUDA, OpenMP, or Pthreads. The Kokkos library
also provides data abstractions to adjust (at compile time) the memory
layout of data structures like 2d and 3d arrays to optimize performance
on different hardware. For more information on Kokkos, see
<a class="reference external" href="https://github.com/kokkos/kokkos">Github</a>. Kokkos is part of
<a class="reference external" href="http://trilinos.sandia.gov/packages/kokkos">Trilinos</a>. The Kokkos
library was written primarily by Carter Edwards, Christian Trott, and
Dan Sunderland (all Sandia).</p>
<p>The SPARTA KOKKOS package contains versions of collide, fix, and compute
styles that use data structures and macros provided by the Kokkos
library, which is included with SPARTA in /lib/kokkos. The KOKKOS
package was developed primarily by Stan Moore (Sandia) with
contributions of various styles by others, including Dan Ibanez
(Sandia), Tim Fuller (Sandia), and Sam Mish (Sandia). For more
information on developing using Kokkos abstractions see the Kokkos
programmers’ guide at /lib/kokkos/doc/Kokkos_PG.pdf.</p>
<p>The KOKKOS package currently provides support for 3 modes of execution
(per MPI task). These are Serial (MPI-only for CPUs and Intel Phi),
OpenMP (threading for many-core CPUs and Intel Phi), and CUDA (for
NVIDIA GPUs). You choose the mode at build time to produce an executable
compatible with specific hardware.</p>
<p><strong>Building SPARTA with the KOKKOS package:</strong></p>
<p>NOTE: Kokkos support within SPARTA must be built with a C++11 compatible
compiler. This means GCC version 4.7.2 or later, Intel 14.0.4 or later,
or Clang 3.5.2 or later is required.</p>
<p>To build with the KOKKOS package start with the provided Kokkos
Makefiles in /src/MAKE/. You may need to modify the KOKKOS_ARCH variable
in the Makefile to match your specific hardware. For example:</p>
<ul class="simple">
<li><p>for Sandy Bridge CPUs, set KOKKOS_ARCH=SNB</p></li>
<li><p>for Broadwell CPUs, set KOKKOS_ARCH=BWD</p></li>
<li><p>for K80 GPUs, set KOKKOS_ARCH=Kepler37</p></li>
<li><p>for P100 GPUs and Power8 CPUs, set KOKKOS_ARCH=Pascal60,Power8</p></li>
</ul>
<p>See the <strong>Advanced Kokkos Options</strong> section below for a listing of all
KOKKOS_ARCH options.</p>
<p><strong>Compile for CPU-only (MPI only, no threading):</strong></p>
<p>Use a C++11 compatible compiler and set KOKKOS_ARCH variable in
/src/MAKE/Makefile.kokkos_mpi_only as described above. The do the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sparta</span><span class="o">/</span><span class="n">src</span>
<span class="n">make</span> <span class="n">yes</span><span class="o">-</span><span class="n">kokkos</span>
<span class="n">make</span> <span class="n">kokkos_mpi_only</span>
</pre></div>
</div>
<p><strong>Compile for CPU-only (MPI plus OpenMP threading):</strong></p>
<p>NOTE: To build with Kokkos support for OpenMP threading, your compiler
must support the OpenMP interface. You should have one or more
multi-core CPUs so that multiple threads can be launched by each MPI
task running on a CPU.</p>
<p>Use a C++11 compatible compiler and set KOKKOS_ARCH variable in
/src/MAKE/Makefile.kokkos_omp as described above. Then do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sparta</span><span class="o">/</span><span class="n">src</span>
<span class="n">make</span> <span class="n">yes</span><span class="o">-</span><span class="n">kokkos</span>
<span class="n">make</span> <span class="n">kokkos_omp</span>
</pre></div>
</div>
<p><strong>Compile for Intel KNL Xeon Phi (Intel Compiler, OpenMPI):</strong></p>
<p>Use a C++11 compatible compiler and do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sparta</span><span class="o">/</span><span class="n">src</span>
<span class="n">make</span> <span class="n">yes</span><span class="o">-</span><span class="n">kokkos</span>
<span class="n">make</span> <span class="n">kokkos_phi</span>
</pre></div>
</div>
<p><strong>Compile for CPUs and GPUs (with OpenMPI or MPICH):</strong></p>
<p>NOTE: To build with Kokkos support for NVIDIA GPUs, NVIDIA CUDA software
version 7.5 or later must be installed on your system.</p>
<p>Use a C++11 compatible compiler and set KOKKOS_ARCH variable in
/src/MAKE/Makefile.kokkos_cuda_mpi for both GPU and CPU as described
above. Then do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sparta</span><span class="o">/</span><span class="n">src</span>
<span class="n">make</span> <span class="n">yes</span><span class="o">-</span><span class="n">kokkos</span>
<span class="n">make</span> <span class="n">kokkos_cuda_mpi</span>
</pre></div>
</div>
<p><strong>Running SPARTA with the KOKKOS package:</strong></p>
<p>All Kokkos operations occur within the context of an individual MPI task
running on a single node of the machine. The total number of MPI tasks
used by SPARTA (one or multiple per compute node) is set in the usual
manner via the mpirun or mpiexec commands, and is independent of Kokkos.
The mpirun or mpiexec command sets the total number of MPI tasks used by
SPARTA (one or multiple per compute node) and the number of MPI tasks
used per node. E.g. the mpirun command in OpenMPI does this via its -np
and -npernode switches. Ditto for MPICH via -np and -ppn.</p>
<p><strong>Running on a multi-core CPU:</strong></p>
<p>Here is a quick overview of how to use the KOKKOS package for CPU
acceleration, assuming one or more 16-core nodes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">16</span> <span class="n">spa_kokkos_mpi_only</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>        <span class="c1"># 1 node, 16 MPI tasks/node, no multi-threading</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="o">-</span><span class="n">ppn</span> <span class="mi">1</span> <span class="n">spa_kokkos_omp</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">16</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>  <span class="c1"># 2 nodes, 1 MPI task/node, 16 threads/task</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="n">spa_kokkos_omp</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">8</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>          <span class="c1"># 1 node,  2 MPI tasks/node, 8 threads/task</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">32</span> <span class="o">-</span><span class="n">ppn</span> <span class="mi">4</span> <span class="n">spa_kokkos_omp</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">4</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>  <span class="c1"># 8 nodes, 4 MPI tasks/node, 4 threads/task</span>
</pre></div>
</div>
<p>To run using the KOKKOS package, use the “-k on”, “-sf kk” and “-pk
kokkos” <a class="reference external" href="Section_start.html#start_7">command-line switches</a> in your
mpirun command. You must use the “-k on” <a class="reference external" href="Section_start.html#start_7">command-line
switch</a> to enable the KOKKOS package. It
takes additional arguments for hardware settings appropriate to your
system. Those arguments are <a class="reference external" href="Section_start.html#start_7">documented
here</a>. For OpenMP use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="n">Nt</span>
</pre></div>
</div>
<p>The “t Nt” option specifies how many OpenMP threads per MPI task to use
with a node. The default is Nt = 1, which is MPI-only mode. Note that
the product of MPI tasks * OpenMP threads/task should not exceed the
physical number of cores (on a node), otherwise performance will suffer.
If hyperthreading is enabled, then the product of MPI tasks * OpenMP
threads/task should not exceed the physical number of cores * hardware
threads. The “-k on” switch also issues a “package kokkos” command (with
no additional arguments) which sets various KOKKOS options to default
values, as discussed on the <a class="reference external" href="package.html">package</a> command doc page.</p>
<p>The “-sf kk” <a class="reference external" href="Section_start.html#start_7">command-line switch</a> will
automatically append the “/kk” suffix to styles that support it. In this
manner no modification to the input script is needed. Alternatively, one
can run with the KOKKOS package by editing the input script as described
below.</p>
<p>NOTE: When using a single OpenMP thread, the Kokkos Serial backend (i.e.
Makefile.kokkos_mpi_only) will give better performance than the OpenMP
backend (i.e. Makefile.kokkos_omp) because some of the overhead to make
the code thread-safe is removed.</p>
<p>NOTE: The default for the <a class="reference external" href="package.html">package kokkos</a> command is
to use “threaded” communication. However, when running on CPUs, it will
typically be faster to use “classic” non-threaded communication. Use the
“-pk kokkos” <a class="reference external" href="Section_start.html#start_7">command-line switch</a> to
change the default <a class="reference external" href="package.html">package kokkos</a> options. See its
doc page for details and default settings. Experimenting with its
options can provide a speed-up for specific calculations. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">16</span> <span class="n">spa_kokkos_mpi_only</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="n">pk</span> <span class="n">kokkos</span> <span class="n">comm</span> <span class="n">classic</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>       <span class="c1"># non-threaded comm</span>
</pre></div>
</div>
<p>For OpenMP, the KOKKOS package uses data duplication (i.e.
thread-private arrays) by default to avoid thread-level write conflicts
in some compute styles. Data duplication is typically fastest for small
numbers of threads (i.e. 8 or less) but does increase memory footprint
and is not scalable to large numbers of threads. An alternative to data
duplication is to use thread-level atomics, which don’t require
duplication. When using the Kokkos Serial backend or the OpenMP backend
with a single thread, no duplication or atomics are used. For CUDA, the
KOKKOS package always uses atomics in these computes when necessary. The
use of atomics instead of duplication can be forced by compiling with
the “-DSPARTA_KOKKOS_USE_ATOMICS” compile switch.</p>
<p><strong>Core and Thread Affinity:</strong></p>
<p>When using multi-threading, it is important for performance to bind both
MPI tasks to physical cores, and threads to physical cores, so they do
not migrate during a simulation.</p>
<p>If you are not certain MPI tasks are being bound (check the defaults for
your MPI installation), binding can be forced with these flags:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OpenMPI</span> <span class="mf">1.8</span><span class="p">:</span> <span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">to</span> <span class="n">socket</span> <span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="n">by</span> <span class="n">socket</span> <span class="o">./</span><span class="n">spa_openmpi</span> <span class="o">...</span>
<span class="n">Mvapich2</span> <span class="mf">2.0</span><span class="p">:</span> <span class="n">mpiexec</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">to</span> <span class="n">socket</span> <span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="n">by</span> <span class="n">socket</span> <span class="o">./</span><span class="n">spa_mvapich</span> <span class="o">...</span>
</pre></div>
</div>
<p>For binding threads with KOKKOS OpenMP, use thread affinity environment
variables to force binding. With OpenMP 3.1 (gcc 4.7 or later, intel 12
or later) setting the environment variable OMP_PROC_BIND=true should be
sufficient. In general, for best performance with OpenMP 4.0 or better
set OMP_PROC_BIND=spread and OMP_PLACES=threads. For binding threads
with the KOKKOS pthreads option, compile SPARTA the KOKKOS HWLOC=yes
option as described below.</p>
<p><strong>Running on Knight’s Landing (KNL) Intel Xeon Phi:</strong></p>
<p>Here is a quick overview of how to use the KOKKOS package for the Intel
Knight’s Landing (KNL) Xeon Phi:</p>
<p>KNL Intel Phi chips have 68 physical cores. Typically 1 to 4 cores are
reserved for the OS, and only 64 or 66 cores are used. Each core has 4
hyperthreads, so there are effectively N = 256 (4*64) or N = 264 (4*66)
cores to run on. The product of MPI tasks * OpenMP threads/task should
not exceed this limit, otherwise performance will suffer. Note that with
the KOKKOS package you do not need to specify how many KNLs there are
per node; each KNL is simply treated as running some number of MPI
tasks.</p>
<p>Examples of mpirun commands that follow these rules are shown below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Intel</span> <span class="n">KNL</span> <span class="n">node</span> <span class="k">with</span> <span class="mi">64</span> <span class="n">cores</span> <span class="p">(</span><span class="mi">256</span> <span class="n">threads</span><span class="o">/</span><span class="n">node</span> <span class="n">via</span> <span class="mi">4</span><span class="n">x</span> <span class="n">hardware</span> <span class="n">threading</span><span class="p">):</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">64</span> <span class="n">spa_kokkos_phi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">4</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>      <span class="c1"># 1 node, 64 MPI tasks/node, 4 threads/task</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">66</span> <span class="n">spa_kokkos_phi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">4</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>      <span class="c1"># 1 node, 66 MPI tasks/node, 4 threads/task</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">32</span> <span class="n">spa_kokkos_phi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">8</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>      <span class="c1"># 1 node, 32 MPI tasks/node, 8 threads/task</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">512</span> <span class="o">-</span><span class="n">ppn</span> <span class="mi">64</span> <span class="n">spa_kokkos_phi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">4</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>  <span class="c1"># 8 nodes, 64 MPI tasks/node, 4 threads/task</span>
</pre></div>
</div>
<p>The -np setting of the mpirun command sets the number of MPI tasks/node.
The “-k on t Nt” command-line switch sets the number of threads/task as
Nt. The product of these two values should be N, i.e. 256 or 264.</p>
<p>NOTE: The default for the <a class="reference external" href="package.html">package kokkos</a> command is
to use “threaded” communication. However, when running on KNL, it will
typically be faster to use “classic” non-threaded communication. Use the
“-pk kokkos” <a class="reference external" href="Section_start.html#start_7">command-line switch</a> to
change the default <a class="reference external" href="package.html">package kokkos</a> options. See its
doc page for details and default settings. Experimenting with its
options can provide a speed-up for specific calculations. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">64</span> <span class="n">spa_kokkos_phi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">t</span> <span class="mi">4</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="n">pk</span> <span class="n">kokkos</span> <span class="n">comm</span> <span class="n">classic</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>      <span class="c1"># non-threaded comm</span>
</pre></div>
</div>
<p>NOTE: MPI tasks and threads should be bound to cores as described above
for CPUs.</p>
<p>NOTE: To build with Kokkos support for Intel Xeon Phi coprocessors such
as Knight’s Corner (KNC), your system must be configured to use them in
“native” mode, not “offload” mode.</p>
<p><strong>Running on GPUs:</strong></p>
<p>Use the “-k” <a class="reference external" href="Section_commands.html#start_7">command-line switch</a> to
specify the number of GPUs per node, and the number of threads per MPI
task. Typically the -np setting of the mpirun command should set the
number of MPI tasks/node to be equal to the # of physical GPUs on the
node. You can assign multiple MPI tasks to the same GPU with the KOKKOS
package, but this is usually only faster if significant portions of the
input script have not been ported to use Kokkos. Using CUDA MPS is
recommended in this scenario. As above for multi-core CPUs (and no GPU),
if N is the number of physical cores/node, then the number of MPI
tasks/node should not exceed N.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">g</span> <span class="n">Ng</span>
</pre></div>
</div>
<p>Here are examples of how to use the KOKKOS package for GPUs, assuming
one or more nodes, each with two GPUs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="n">spa_kokkos_cuda_mpi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">g</span> <span class="mi">2</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>          <span class="c1"># 1 node,   2 MPI tasks/node, 2 GPUs/node</span>
<span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">32</span> <span class="o">-</span><span class="n">ppn</span> <span class="mi">2</span> <span class="n">spa_kokkos_cuda_mpi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">g</span> <span class="mi">2</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>  <span class="c1"># 16 nodes, 2 MPI tasks/node, 2 GPUs/node (32 GPUs total)</span>
</pre></div>
</div>
<p>NOTE: The default for the <a class="reference external" href="package.html">package kokkos</a> command is
to use “parallel” reduction of statistics along with threaded
communication. However, using “atomic” reduction is typically faster for
GPUs. Use the “-pk kokkos” <a class="reference external" href="Section_start.html#start_7">command-line
switch</a> to change the default <a class="reference external" href="package.html">package
kokkos</a> options. See its doc page for details and
default settings. Experimenting with its options can provide a speed-up
for specific calculations. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="n">spa_kokkos_cuda_mpi</span> <span class="o">-</span><span class="n">k</span> <span class="n">on</span> <span class="n">g</span> <span class="mi">2</span> <span class="o">-</span><span class="n">sf</span> <span class="n">kk</span> <span class="o">-</span><span class="n">pk</span> <span class="n">kokkos</span> <span class="n">reduction</span> <span class="n">atomic</span> <span class="o">-</span><span class="ow">in</span> <span class="ow">in</span><span class="o">.</span><span class="n">collide</span>      <span class="c1"># set reduction = atomic</span>
</pre></div>
</div>
<p>NOTE: Using OpenMP threading and CUDA together is currently not possible
with the SPARTA KOKKOS package.</p>
<p>NOTE: For good performance of the KOKKOS package on GPUs, you must have
Kepler generation GPUs (or later). The Kokkos library exploits texture
cache options not supported by Telsa generation GPUs (or older).</p>
<p>NOTE: When using a GPU, you will achieve the best performance if your
input script does not use fix or compute styles which are not yet
Kokkos-enabled. This allows data to stay on the GPU for multiple
timesteps, without being copied back to the host CPU. Invoking a
non-Kokkos fix or compute, or performing I/O for <a class="reference external" href="stat.html">stat</a> or
<a class="reference external" href="dump.html">dump</a> output will cause data to be copied back to the CPU
incurring a performance penalty.</p>
<p><strong>Run with the KOKKOS package by editing an input script:</strong></p>
<p>Alternatively the effect of the “-sf” or “-pk” switches can be
duplicated by adding the <a class="reference external" href="package.html">package kokkos</a> or <a class="reference external" href="suffix.html">suffix
kk</a> commands to your input script.</p>
<p>The discussion above for building SPARTA with the KOKKOS package, the
mpirun/mpiexec command, and setting appropriate thread are the same.</p>
<p>You must still use the “-k on” <a class="reference external" href="Section_start.html#start_7">command-line
switch</a> to enable the KOKKOS package, and
specify its additional arguments for hardware options appropriate to
your system, as documented above.</p>
<p>You can use the <a class="reference external" href="suffix.html">suffix kk</a> command, or you can
explicitly add a “kk” suffix to individual styles in your input script,
e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">collide</span> <span class="n">vss</span><span class="o">/</span><span class="n">kk</span> <span class="n">air</span> <span class="n">ar</span><span class="o">.</span><span class="n">vss</span>
</pre></div>
</div>
<p>You only need to use the <a class="reference external" href="package.html">package kokkos</a> command if
you wish to change any of its option defaults, as set by the “-k on”
<a class="reference external" href="Section_start.html#start_7">command-line switch</a>.</p>
<p><strong>Speed-ups to expect:</strong></p>
<p>The performance of KOKKOS running in different modes is a function of
your hardware, which KOKKOS-enable styles are used, and the problem
size.</p>
<p>Generally speaking, the following rules of thumb apply:</p>
<p>When running on CPUs only, with a single thread per MPI task, the
performance difference of a KOKKOS style and (un-accelerated) styles
(MPI-only mode)is typically small (less than 20%).</p>
<p>See the <a class="reference external" href="http://sparta.sandia.gov/bench.html">Benchmark page</a> of the
SPARTA web site for performance of the KOKKOS package on different
hardware.</p>
<p><strong>Advanced Kokkos options:</strong></p>
<p>There are other allowed options when building with the KOKKOS package.
As above, they can be set either as variables on the make command line
or in Makefile.machine. This is the full list of options, including
those discussed above. Each takes a value shown below. The default value
is listed, which is set in the /lib/kokkos/Makefile.kokkos file.</p>
<ul class="simple">
<li><p>KOKKOS_DEVICES, values = <em>Serial</em>, <em>OpenMP</em>, <em>Pthreads</em>, <em>Cuda</em>,
default = <em>OpenMP</em></p></li>
<li><p>KOKKOS_ARCH, values = <em>KNC</em>, <em>SNB</em>, <em>HSW</em>, <em>Kepler30</em>, <em>Kepler32</em>,
<em>Kepler35</em>, <em>Kepler37</em>, <em>Maxwell50</em>, <em>Maxwell52</em>, <em>Maxwell53</em>,
<em>Pascal60</em>, <em>Pascal61</em>, <em>ARMv80</em>, <em>ARMv81</em>, <em>ARMv81</em>,
<em>ARMv8-ThunderX</em>, <em>BGQ</em>, <em>Power7</em>, <em>Power8</em>, <em>Power9</em>, <em>KNL</em>, <em>BDW</em>,
<em>SKX</em>, default = <em>none</em></p></li>
<li><p>KOKKOS_DEBUG, values = <em>yes</em>, <em>no</em>, default = <em>no</em></p></li>
<li><p>KOKKOS_USE_TPLS, values = <em>hwloc</em>, <em>librt</em>, <em>experimental_memkind</em>,
default = <em>none</em></p></li>
<li><p>KOKKOS_CXX_STANDARD, values = <em>c++11</em>, <em>c++1z</em>, default = <em>c++11</em></p></li>
<li><p>KOKKOS_OPTIONS, values = <em>aggressive_vectorization</em>,
<em>disable_profiling</em>, default = <em>none</em></p></li>
<li><p>KOKKOS_CUDA_OPTIONS, values = <em>force_uvm</em>, <em>use_ldg</em>, <em>rdc</em>,
<em>enable_lambda</em>, default = <em>enable_lambda</em></p></li>
</ul>
<p>KOKKOS_DEVICES sets the parallelization method used for Kokkos code
(within SPARTA). KOKKOS_DEVICES=Serial means that no threading will be
used. KOKKOS_DEVICES=OpenMP means that OpenMP threading will be used.
KOKKOS_DEVICES=Pthreads means that pthreads will be used.
KOKKOS_DEVICES=Cuda means an NVIDIA GPU running CUDA will be used.</p>
<p>KOKKOS_ARCH enables compiler switches needed when compiling for a
specific hardware:</p>
<ul class="simple">
<li><p>ARMv80 = ARMv8.0 Compatible CPU</p></li>
<li><p>ARMv81 = ARMv8.1 Compatible CPU</p></li>
<li><p>ARMv8-ThunderX = ARMv8 Cavium ThunderX CPU</p></li>
<li><p>SNB = Intel Sandy/Ivy Bridge CPUs</p></li>
<li><p>HSW = Intel Haswell CPUs</p></li>
<li><p>BDW = Intel Broadwell Xeon E-class CPUs</p></li>
<li><p>SKX = Intel Sky Lake Xeon E-class HPC CPUs (AVX512)</p></li>
<li><p>KNC = Intel Knights Corner Xeon Phi</p></li>
<li><p>KNL = Intel Knights Landing Xeon Phi</p></li>
<li><p>Kepler30 = NVIDIA Kepler generation CC 3.0</p></li>
<li><p>Kepler32 = NVIDIA Kepler generation CC 3.2</p></li>
<li><p>Kepler35 = NVIDIA Kepler generation CC 3.5</p></li>
<li><p>Kepler37 = NVIDIA Kepler generation CC 3.7</p></li>
<li><p>Maxwell50 = NVIDIA Maxwell generation CC 5.0</p></li>
<li><p>Maxwell52 = NVIDIA Maxwell generation CC 5.2</p></li>
<li><p>Maxwell53 = NVIDIA Maxwell generation CC 5.3</p></li>
<li><p>Pascal60 = NVIDIA Pascal generation CC 6.0</p></li>
<li><p>Pascal61 = NVIDIA Pascal generation CC 6.1</p></li>
<li><p>BGQ = IBM Blue Gene/Q CPUs</p></li>
<li><p>Power8 = IBM POWER8 CPUs</p></li>
<li><p>Power9 = IBM POWER9 CPUs</p></li>
</ul>
<p>KOKKOS_USE_TPLS=hwloc binds threads to hardware cores, so they do not
migrate during a simulation. KOKKOS_USE_TPLS=hwloc should always be used
if running with KOKKOS_DEVICES=Pthreads for pthreads. It is not
necessary for KOKKOS_DEVICES=OpenMP for OpenMP, because OpenMP provides
alternative methods via environment variables for binding threads to
hardware cores. More info on binding threads to cores is given in the
<a class="reference external" href="Section_accelerate.html#acc_3">Accelerating SPARTA</a>.</p>
<p>KOKKOS_USE_TPLS=librt enables use of a more accurate timer mechanism on
most Unix platforms. This library is not available on all platforms.</p>
<p>KOKKOS_DEBUG is only useful when developing a Kokkos-enabled style
within SPARTA. KOKKOS_DEBUG=yes enables printing of run-time debugging
information that can be useful. It also enables runtime bounds checking
on Kokkos data structures.</p>
<p>KOKKOS_CXX_STANDARD and KOKKOS_OPTIONS are typically not changed when
building SPARTA.</p>
<p>KOKKOS_CUDA_OPTIONS are additional options for CUDA. The SPARTA KOKKOS
package must be compiled with the <em>enable_lambda</em> option when using
GPUs.</p>
<p><strong>Restrictions:</strong></p>
<p>Currently, there are no precision options with the KOKKOS package. All
compilation and computation is performed in double precision.</p>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, JF

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>