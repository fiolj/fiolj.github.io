

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>11. Python interface to SPARTA &mdash; SPARTA 7 May 2020 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/rtd_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="12. Errors" href="Section_errors.html" />
    <link rel="prev" title="10. Modifying &amp; extending SPARTA" href="Section_modify.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> SPARTA
          

          
          </a>

          
            
            
              <div class="version">
                3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Section_intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_start.html">2. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_commands.html">3. Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_packages.html">4. Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_accelerate.html">5. Accelerating SPARTA performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_howto.html">6. How-to discussions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_example.html">7. Example problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_perf.html">8. Performance &amp; scalability</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_tools.html">9. Additional tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_modify.html">10. Modifying &amp; extending SPARTA</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Python interface to SPARTA</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#building-sparta-as-a-shared-library">11.1. Building SPARTA as a shared library</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-the-python-wrapper-into-python">11.2. Installing the Python wrapper into Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extending-python-with-mpi-to-run-in-parallel">11.3. Extending Python with MPI to run in parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-the-python-sparta-interface">11.4. Testing the Python-SPARTA interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-sparta-and-python-in-serial">11.4.1. Test SPARTA and Python in serial:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-sparta-and-python-in-parallel">11.4.2. Test SPARTA and Python in parallel:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-python-scripts">11.4.3. Running Python scripts:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-sparta-from-python">11.5. Using SPARTA from Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-python-scripts-that-use-sparta">11.6. Example Python scripts that use SPARTA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Section_errors.html">12. Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="Section_history.html">13. Future and history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SPARTA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>11. Python interface to SPARTA</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Section_python.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python-interface-to-sparta">
<span id="python"></span><h1>11. Python interface to SPARTA<a class="headerlink" href="#python-interface-to-sparta" title="Permalink to this headline">¶</a></h1>
<p>This section describes how to build and use SPARTA via a Python
interface.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#building-sparta-as-a-shared-library" id="id1">Building SPARTA as a shared library</a></p></li>
<li><p><a class="reference internal" href="#installing-the-python-wrapper-into-python" id="id2">Installing the Python wrapper into Python</a></p></li>
<li><p><a class="reference internal" href="#extending-python-with-mpi-to-run-in-parallel" id="id3">Extending Python with MPI to run in parallel</a></p></li>
<li><p><a class="reference internal" href="#testing-the-python-sparta-interface" id="id4">Testing the Python-SPARTA interface</a></p></li>
<li><p><a class="reference internal" href="#using-sparta-from-python" id="id5">Using SPARTA from Python</a></p></li>
<li><p><a class="reference internal" href="#example-python-scripts-that-use-sparta" id="id6">Example Python scripts that use SPARTA</a></p></li>
</ul>
</div>
<p>The SPARTA distribution includes the file python/sparta.py which wraps the library interface to SPARTA. This file makes it is possible to run SPARTA, invoke SPARTA commands or give it an input script, extract SPARTA results, and modify internal SPARTA variables, either from a Python script or interactively from a Python prompt. You can do the former in serial or parallel. Running Python interactively in parallel does not generally work, unless you have a package installed that extends your Python to enable multiple instances of Python to read what you type.</p>
<p><a class="reference external" href="http://www.python.org">Python</a> is a powerful scripting and programming language which can be used to wrap software like SPARTA and many other packages. It can be used to glue multiple pieces of software together, e.g. to run a coupled or multiscale model.
See <a class="reference internal" href="Section_howto.html#howto-other-code"><span class="std std-ref">Coupling SPARTA to other codes</span></a> of the manual and the examples/COUPLE directory of the distribution for more ideas about coupling SPARTA to other codes. See <a class="reference internal" href="Section_start.html#build-library"><span class="std std-ref">Building SPARTA as a library</span></a> about how to build SPARTA as a library, and <a class="reference internal" href="Section_howto.html#howto-library"><span class="std std-ref">Library interface to SPARTA</span></a> for a description of the library interface provided in src/library.cpp and src/library.h and how to extend it for your needs. As described below, that interface is what is exposed to Python. It is designed to be easy to add functions to. This can extend the Python inteface as well. See details below.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The examples/COUPLE dir has not been added to the distribution yet.</p>
</div>
<p>By using the Python interface, SPARTA can also be coupled with a GUI or other visualization tools that display graphs or animations in real time as SPARTA runs. Examples of such scripts are included in the python directory.</p>
<p>Two advantages of using Python are how concise the language is, and that it can be run interactively, enabling rapid development and debugging of programs. If you use it to mostly invoke costly operations within SPARTA, such as running a simulation for a reasonable number of timesteps, then the overhead cost of invoking SPARTA thru Python will be negligible.</p>
<p>Before using SPARTA from a Python script, you need to do two things. You need to build SPARTA as a dynamic shared library, so it can be loaded by Python. And you need to tell Python how to find the library and the Python wrapper file python/sparta.py. Both these steps are discussed below. If you wish to run SPARTA in parallel from Python, you also need to extend your Python with MPI. This is also discussed below.</p>
<p>The Python wrapper for SPARTA uses the amazing and magical (to me) “ctypes” package in Python, which auto-generates the interface code needed between Python and a set of C interface routines for a library.  Ctypes is part of standard Python for versions 2.5 and later. You can check which version of Python you have installed, by simply typing “python” at a shell prompt.</p>
<div class="section" id="building-sparta-as-a-shared-library">
<h2><a class="toc-backref" href="#id1">11.1. Building SPARTA as a shared library</a><a class="headerlink" href="#building-sparta-as-a-shared-library" title="Permalink to this headline">¶</a></h2>
<p>Instructions on how to build SPARTA as a shared library are given in <a class="reference internal" href="Section_start.html#build-library"><span class="std std-ref">Building SPARTA as a library</span></a>. A shared library is one that is dynamically loadable, which is what Python requires. On Linux this is a library file that ends in “.so”, not “.a”.</p>
<p>From the src directory, type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">makeshlib</span>
<span class="n">make</span> <span class="o">-</span><span class="n">f</span> <span class="n">Makefile</span><span class="o">.</span><span class="n">shlib</span> <span class="n">foo</span>
</pre></div>
</div>
<p>where foo is the machine target name, such as icc or g++ or serial. This should create the file libsparta_foo.so in the src directory, as well as a soft link libsparta.so, which is what the Python wrapper will load by default. Note that if you are building multiple machine versions of the shared library, the soft link is always set to the most recently built version.</p>
<p>If this fails, see <a class="reference internal" href="Section_start.html#start-optional-packages"><span class="std std-ref">Making SPARTA with optional packages</span></a> for more details, especially if your SPARTA build uses auxiliary libraries like MPI which may not be built as shared libraries on your system.</p>
</div>
<div class="section" id="installing-the-python-wrapper-into-python">
<h2><a class="toc-backref" href="#id2">11.2. Installing the Python wrapper into Python</a><a class="headerlink" href="#installing-the-python-wrapper-into-python" title="Permalink to this headline">¶</a></h2>
<p>For Python to invoke SPARTA, there are 2 files it needs to know about:</p>
<ul class="simple">
<li><p>python/sparta.py</p></li>
<li><p>src/libsparta.so</p></li>
</ul>
<p>Sparta.py is the Python wrapper on the SPARTA library interface.
Libsparta.so is the shared SPARTA library that Python loads, as
described above.</p>
<p>You can insure Python can find these files in one of two ways:</p>
<ul class="simple">
<li><p>set two environment variables</p></li>
<li><p>run the python/install.py script</p></li>
</ul>
<p>If you set the paths to these files as environment variables, you only
have to do it once. For the csh or tcsh shells, add something like this
to your ~/.cshrc file, one line for each of the two files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>setenv PYTHONPATH $PYTHONPATH:/home/sjplimp/sparta/python
setenv LD_LIBRARY_PATH $LD_LIBRARY_PATH:/home/sjplimp/sparta/src
</pre></div>
</div>
<p>If you use the python/install.py script, you need to invoke it every
time you rebuild SPARTA (as a shared library) or make changes to the
python/sparta.py file.</p>
<p>You can invoke install.py from the python directory as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">install</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="n">libdir</span><span class="p">]</span> <span class="p">[</span><span class="n">pydir</span><span class="p">]</span>
</pre></div>
</div>
<p>The optional libdir is where to copy the SPARTA shared library to; the default is /usr/local/lib. The optional pydir is where to copy the sparta.py file to; the default is the site-packages directory of the version of Python that is running the install script.</p>
<p>Note that libdir must be a location that is in your default LD_LIBRARY_PATH, like /usr/local/lib or /usr/lib. And pydir must be a location that Python looks in by default for imported modules, like its site-packages dir. If you want to copy these files to non-standard locations, such as within your own user space, you will need to set your <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> and <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> environment variables accordingly, as above.</p>
<p>If the install.py script does not allow you to copy files into system directories, prefix the python command with “sudo”. If you do this, make sure that the Python that root runs is the same as the Python you run.  E.g. you may need to do something like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="n">install</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="n">libdir</span><span class="p">]</span> <span class="p">[</span><span class="n">pydir</span><span class="p">]</span>
</pre></div>
</div>
<p>You can also invoke install.py from the make command in the src directory as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">make</span> <span class="n">install</span><span class="o">-</span><span class="n">python</span>
</pre></div>
</div>
<p>In this mode you cannot append optional arguments. Again, you may need to prefix this with “sudo”. In this mode you cannot control which Python is invoked by root.</p>
<p>Note that if you want Python to be able to load different versions of the SPARTA shared library (see <a class="reference internal" href="#python-using"><span class="std std-ref">this section</span></a> below), you will need to manually copy files like libsparta_g++.so into the appropriate system directory. This is not needed if you set the LD_LIBRARY_PATH environment variable as described above.</p>
</div>
<div class="section" id="extending-python-with-mpi-to-run-in-parallel">
<h2><a class="toc-backref" href="#id3">11.3. Extending Python with MPI to run in parallel</a><a class="headerlink" href="#extending-python-with-mpi-to-run-in-parallel" title="Permalink to this headline">¶</a></h2>
<p>If you wish to run SPARTA in parallel from Python, you need to extend your Python with an interface to MPI. This also allows you to make MPI calls directly from Python in your script, if you desire.</p>
<p>There are several Python packages available that purport to wrap MPI as a library and allow MPI functions to be called from Python.</p>
<p>These include</p>
<ul class="simple">
<li><p><a class="reference external" href="http://pympi.sourceforge.net/">pyMPI</a></p></li>
<li><p><a class="reference external" href="http://code.google.com/p/maroonmpi/">maroonmpi</a></p></li>
<li><p><a class="reference external" href="http://code.google.com/p/mpi4py/">mpi4py</a></p></li>
<li><p><a class="reference external" href="http://nbcr.sdsc.edu/forum/viewtopic.php?t=89&amp;sid=c997fefc3933bd66204875b436940f16">myMPI</a></p></li>
<li><p><a class="reference external" href="http://code.google.com/p/pypar">Pypar</a></p></li>
</ul>
<p>All of these except pyMPI work by wrapping the MPI library and exposing (some portion of) its interface to your Python script. This means Python cannot be used interactively in parallel, since they do not address the issue of interactive input to multiple instances of Python running on different processors. The one exception is pyMPI, which alters the Python interpreter to address this issue, and (I believe) creates a new alternate executable (in place of “python” itself) as a result.</p>
<p>In principle any of these Python/MPI packages should work to invoke SPARTA in parallel and MPI calls themselves from a Python script which is itself running in parallel. However, when I downloaded and looked at a few of them, their documentation was incomplete and I had trouble with their installation. It’s not clear if some of the packages are still being actively developed and supported.</p>
<p>The one I recommend, since I have successfully used it with SPARTA, is Pypar. Pypar requires the ubiquitous <a class="reference external" href="http://numpy.scipy.org">Numpy package</a> be installed in your Python. After launching python, type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
<p>to see if it is installed. If not, here is how to install it (version 1.3.0b1 as of April 2009). Unpack the numpy tarball and from its top-level directory, type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build</span>
<span class="n">sudo</span> <span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>The “sudo” is only needed if required to copy Numpy files into your
Python distribution’s site-packages directory.</p>
<p>To install Pypar (version pypar-2.1.4_94 as of Aug 2012), unpack it and
from its “source” directory, type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build</span>
<span class="n">sudo</span> <span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>Again, the “sudo” is only needed if required to copy Pypar files into your Python distribution’s site-packages directory.</p>
<p>If you have successully installed Pypar, you should be able to run Python and type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pypar</span>
</pre></div>
</div>
<p>without error. You should also be able to run python in parallel on a simple test script</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="n">python</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>where test.py contains the lines</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pypar</span>
<span class="nb">print</span> <span class="s2">&quot;Proc </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2"> procs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pypar</span><span class="o">.</span><span class="n">rank</span><span class="p">(),</span><span class="n">pypar</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</pre></div>
</div>
<p>and see one line of output for each processor you run on.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>To use Pypar and SPARTA in parallel from Python, you must insure both are using the same version of MPI. If you only have one MPI installed on your system, this is not an issue, but it can be if you have multiple MPIs. Your SPARTA build is explicit about which MPI it is using, since you specify the details in your lo-level src/MAKE/Makefile.foo file.
Pypar uses the “mpicc” command to find information about the MPI it uses to build against. And it tries to load “libmpi.so” from the LD_LIBRARY_PATH. This may or may not find the MPI library that SPARTA is using.
If you have problems running both Pypar and SPARTA together, this is an issue you may need to address, e.g. by moving other MPI installations so that Pypar finds the right one.</p>
</div>
</div>
<div class="section" id="testing-the-python-sparta-interface">
<h2><a class="toc-backref" href="#id4">11.4. Testing the Python-SPARTA interface</a><a class="headerlink" href="#testing-the-python-sparta-interface" title="Permalink to this headline">¶</a></h2>
<p>To test if SPARTA is callable from Python, launch Python interactively
and type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sparta</span> <span class="k">import</span> <span class="n">sparta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">()</span>
</pre></div>
</div>
<p>If you get no errors, you’re ready to use SPARTA from Python. If the 2nd
command fails, the most common error to see is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ne">OSError</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">load</span> <span class="n">SPARTA</span> <span class="n">dynamic</span> <span class="n">library</span>
</pre></div>
</div>
<p>which means Python was unable to load the SPARTA shared library. This
typically occurs if the system can’t find the SPARTA shared library or
one of the auxiliary shared libraries it depends on, or if something
about the library is incompatible with your Python. The error message
should give you an indication of what went wrong.</p>
<p>You can also test the load directly in Python as follows, without first
importing from the sparta.py file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">CDLL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libsparta.so&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If an error occurs, carefully go thru the steps in <a class="reference internal" href="Section_start.html#build-library"><span class="std std-ref">Building SPARTA as a library</span></a> and above about building a shared library and about insuring Python can find the necessary two files it needs.</p>
<div class="section" id="test-sparta-and-python-in-serial">
<h3>11.4.1. Test SPARTA and Python in serial:<a class="headerlink" href="#test-sparta-and-python-in-serial" title="Permalink to this headline">¶</a></h3>
<p>To run a SPARTA test in serial, type these lines into Python interactively from the bench directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sparta</span> <span class="k">import</span> <span class="n">sparta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spa</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="s2">&quot;in.free&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or put the same lines in the file test.py and run it as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Either way, you should see the results of running the <code class="docutils literal notranslate"><span class="pre">in.free</span></code> benchmark on a single processor appear on the screen, the same as if you had typed something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spa_g</span><span class="o">++</span> <span class="o">&lt;</span> <span class="ow">in</span><span class="o">.</span><span class="n">free</span>
</pre></div>
</div>
<p>You can also pass command-line switches, e.g. to set input script variables, through the Python interface.</p>
<p>Replacing the “spa = sparta()” line above with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;100&quot;</span><span class="p">,</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;100&quot;</span><span class="p">,</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">,</span><span class="s2">&quot;100&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>is the same as typing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spa_g</span><span class="o">++</span> <span class="o">-</span><span class="n">v</span> <span class="n">x</span> <span class="mi">100</span> <span class="o">-</span><span class="n">v</span> <span class="n">y</span> <span class="mi">100</span> <span class="o">-</span><span class="n">v</span> <span class="n">z</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="ow">in</span><span class="o">.</span><span class="n">free</span>
</pre></div>
</div>
<p>from the command line.</p>
</div>
<div class="section" id="test-sparta-and-python-in-parallel">
<h3>11.4.2. Test SPARTA and Python in parallel:<a class="headerlink" href="#test-sparta-and-python-in-parallel" title="Permalink to this headline">¶</a></h3>
<p>To run SPARTA in parallel, assuming you have installed the <a class="reference external" href="http://datamining.anu.edu.au/~ole/pypar">Pypar</a> package as discussed above, create a test.py file containing these lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pypar</span>
<span class="kn">from</span> <span class="nn">sparta</span> <span class="k">import</span> <span class="n">sparta</span>
<span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">()</span>
<span class="n">spa</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="s2">&quot;in.free&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Proc </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2"> procs has&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pypar</span><span class="o">.</span><span class="n">rank</span><span class="p">(),</span><span class="n">pypar</span><span class="o">.</span><span class="n">size</span><span class="p">()),</span><span class="n">lmp</span>
<span class="n">pypar</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</pre></div>
</div>
<p>You can then run it in parallel as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="n">python</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>and you should see the same output as if you had typed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="n">spa_g</span><span class="o">++</span> <span class="o">&lt;</span> <span class="ow">in</span><span class="o">.</span><span class="n">lj</span>
</pre></div>
</div>
<p>Note that if you leave out the 3 lines from test.py that specify Pypar commands you will instantiate and run SPARTA independently on each of the P processors specified in the mpirun command. In this case you should get 4 sets of output, each showing that a SPARTA run was made on a single processor, instead of one set of output showing that SPARTA ran on 4 processors. If the 1-processor outputs occur, it means that Pypar is not working correctly.</p>
<p>Also note that once you import the PyPar module, Pypar initializes MPI for you, and you can use MPI calls directly in your Python script, as described in the Pypar documentation. The last line of your Python script should be pypar.finalize(), to insure MPI is shut down correctly.</p>
</div>
<div class="section" id="running-python-scripts">
<h3>11.4.3. Running Python scripts:<a class="headerlink" href="#running-python-scripts" title="Permalink to this headline">¶</a></h3>
<p>Note that any Python script (not just for SPARTA) can be invoked in one of several ways:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">foo</span><span class="o">.</span><span class="n">script</span>
<span class="o">%</span> <span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">foo</span><span class="o">.</span><span class="n">script</span>
<span class="o">%</span> <span class="n">foo</span><span class="o">.</span><span class="n">script</span>
</pre></div>
</div>
<p>The last command requires that the first line of the script be something
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/local/bin/python</span>
<span class="c1">#!/usr/local/bin/python -i</span>
</pre></div>
</div>
<p>where the path points to where you have Python installed, and requires that you have made the script file executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">foo</span><span class="o">.</span><span class="n">script</span>
</pre></div>
</div>
<p>Without the “-i” flag, Python will exit when the script finishes. With the “-i” flag, you will be left in the Python interpreter when the script finishes, so you can type subsequent commands. As mentioned above, you can only run Python interactively when running Python on a single processor, not in parallel.</p>
</div>
</div>
<div class="section" id="using-sparta-from-python">
<span id="python-using"></span><h2><a class="toc-backref" href="#id5">11.5. Using SPARTA from Python</a><a class="headerlink" href="#using-sparta-from-python" title="Permalink to this headline">¶</a></h2>
<p>The Python interface to SPARTA consists of a Python “sparta” module, the source code for which is in python/sparta.py, which creates a “sparta” object, with a set of methods that can be invoked on that object. The sample Python code below assumes you have first imported the “sparta” module in your Python script, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sparta</span> <span class="k">import</span> <span class="n">sparta</span>
</pre></div>
</div>
<p>These are the methods defined by the sparta module. If you look at the file src/library.cpp you will see that they correspond one-to-one with calls you can make to the SPARTA library from a C++ or C or Fortran program.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">()</span>           <span class="c1"># create a SPARTA object using the default libsparta.so library</span>
<span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">(</span><span class="s2">&quot;g++&quot;</span><span class="p">)</span>      <span class="c1"># create a SPARTA object using the libsparta_g++.so library</span>
<span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>    <span class="c1"># ditto, with command-line args, e.g. list = [&quot;-echo&quot;,&quot;screen&quot;]</span>
<span class="n">spa</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">(</span><span class="s2">&quot;g++&quot;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>              <span class="c1"># destroy a SPARTA object</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spa</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>           <span class="c1"># run an entire input script, file = &quot;in.lj&quot;</span>
<span class="n">spa</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>         <span class="c1"># invoke a single SPARTA command, cmd = &quot;run 100&quot;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fnum</span> <span class="o">=</span> <span class="n">spa</span><span class="o">.</span><span class="n">extract_global</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span> <span class="c1"># extract a global quantity</span>
                                     <span class="c1"># name = &quot;dt&quot;, &quot;fnum&quot;, etc</span>
                     <span class="c1"># type = 0 = int</span>
                     <span class="c1">#        1 = double</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">temp</span> <span class="o">=</span> <span class="n">spa</span><span class="o">.</span><span class="n">extract_compute</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">style</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span> <span class="c1"># extract value(s) from a compute</span>
                                          <span class="c1"># id = ID of compute</span>
                      <span class="c1"># style = 0 = global data</span>
                      <span class="c1">#     1 = per particle data</span>
                      <span class="c1">#     2 = per grid cell data</span>
                      <span class="c1">#     3 = per surf element data</span>
                      <span class="c1"># type = 0 = scalar</span>
                      <span class="c1">#    1 = vector</span>
                      <span class="c1">#        2 = array</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">spa</span><span class="o">.</span><span class="n">extract_variable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>  <span class="c1"># extract value(s) from a variable</span>
                                   <span class="c1"># name = name of variable</span>
                       <span class="c1"># flag = 0 = equal-style variable</span>
                       <span class="c1">#        1 = particle-style variable</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Currently, the creation of a SPARTA object from within sparta.py does not take an MPI communicator as an argument. There should be a way to do this, so that the SPARTA instance runs on a subset of processors if desired, but I don’t know how to do it from Pypar. So for now, it runs with MPI_COMM_WORLD, which is all the processors.
If someone figures out how to do this with one or more of the Python wrappers for MPI, like Pypar, please let us know and we will amend these doc pages.</p>
</div>
<p>Note that you can create multiple SPARTA objects in your Python script,
and coordinate and run multiple simulations, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sparta</span> <span class="k">import</span> <span class="n">sparta</span>
<span class="n">spa1</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">()</span>
<span class="n">spa2</span> <span class="o">=</span> <span class="n">sparta</span><span class="p">()</span>
<span class="n">spa1</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="s2">&quot;in.file1&quot;</span><span class="p">)</span>
<span class="n">spa2</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="s2">&quot;in.file2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">file()</span></code> and <code class="docutils literal notranslate"><span class="pre">command()</span></code> methods allow an input script or single commands to be invoked.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">extract_global()</span></code>, <code class="docutils literal notranslate"><span class="pre">extract_compute()</span></code>, and <code class="docutils literal notranslate"><span class="pre">extract_variable()</span></code> methods return values or pointers to data structures internal to SPARTA.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">extract_global()</span></code> see the src/library.cpp file for the list of valid
names. New names can easily be added. A double or integer is returned.
You need to specify the appropriate data type via the type argument.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">extract_compute()</span></code>, the global, per particle, per grid cell, or per surface element results calulated by the compute can be accessed. What is returned depends on whether the compute calculates a scalar or vector or array. For a scalar, a single double value is returned. If the compute or fix calculates a vector or array, a pointer to the internal SPARTA data is returned, which you can use via normal Python subscripting. See <a class="reference internal" href="Section_howto.html#howto-output"><span class="std std-ref">Output from SPARTA (stats, dumps, computes, fixes, variables)</span></a> of the manual for a discussion of global, per particle, per grid, and per surf data, and of scalar, vector, and array data types. See the doc pages for individual <a class="reference internal" href="compute.html#command-compute"><span class="std std-ref">computes</span></a> for a description of what they calculate and store.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">extract_variable()</span></code>, an <a class="reference internal" href="variable.html#command-variable"><span class="std std-ref">equal-style or particle-style variable</span></a> is evaluated and its result returned.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">equal-style</span></code> variables a single double value is returned and the group argument is ignored. For <code class="docutils literal notranslate"><span class="pre">particle-style</span></code> variables, a vector of doubles is returned, one value per particle, which you can use via normal Python subscripting.</p>
<p>As noted above, these Python class methods correspond one-to-one with the functions in the SPARTA library interface in src/library.cpp and library.h. This means you can extend the Python wrapper via the following steps:</p>
<ul class="simple">
<li><p>Add a new interface function to src/library.cpp and src/library.h.</p></li>
<li><p>Rebuild SPARTA as a shared library.</p></li>
<li><p>Add a wrapper method to python/sparta.py for this interface function.</p></li>
<li><p>You should now be able to invoke the new interface function from a Python script. Isn’t ctypes amazing?</p></li>
</ul>
</div>
<div class="section" id="example-python-scripts-that-use-sparta">
<h2><a class="toc-backref" href="#id6">11.6. Example Python scripts that use SPARTA</a><a class="headerlink" href="#example-python-scripts-that-use-sparta" title="Permalink to this headline">¶</a></h2>
<p>There are demonstration Python scripts included in the python/examples directory of the SPARTA distribution, to illustrate what is possible when Python wraps SPARTA.</p>
<p>See the python/README file for more details.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Section_errors.html" class="btn btn-neutral float-right" title="12. Errors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Section_modify.html" class="btn btn-neutral float-left" title="10. Modifying &amp; extending SPARTA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, JF

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>